(function(a){function m(t,m){function l(a,c,h,e){return'<div class="photo-editor"><div class="preview"><img src="'+c+'" alt=""/></div><div>'+(b.hasName?'<label for="photo_name_'+a+'">'+b.nameLabel+':</label><input type="text" name="photo['+a+'][name]" class="input-xlarge" value="'+h+'" id="photo_name_'+a+'"/>':"")+(b.hasDesc?'<label for="photo_description_'+a+'">'+b.descriptionLabel+':</label><textarea name="photo['+a+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+a+'">'+e+"</textarea>":"")+"</div></div>"}function r(a,c,h,e,d){c='<div id="'+b.wId+"-"+a+'" class="photo"><div class="image-preview"><img src="'+c+'"/></div><div class="caption">';b.hasName&&(c+="<h5>"+h+"</h5>");b.hasDesc&&(c+="<p>"+e+"</p>");return c+='</div><input type="hidden" name="order['+a+']" value="'+d+'"/><div class="actions">'+(b.hasName||b.hasDesc?'<span data-photo-id="'+a+'" class="editPhoto btn btn-primary"><i class="icon-edit icon-white"></i></span> ':"")+'<span data-photo-id="'+a+'" class="deletePhoto btn btn-danger"><i class="icon-remove icon-white"></i></span></div><input type="checkbox" class="photo-select"/></div>'}function u(f){f.preventDefault();var c=a(this).data("photo-id");a.ajax({type:"POST",url:b.deleteUrl,data:"id="+c+(b.csrfToken?"&"+b.csrfTokenName+"="+b.csrfToken:""),success:function(f){"OK"==f?a("#"+b.wId+"-"+c).remove():alert(f)}});return!1}function v(b){b.preventDefault();b=a(this).data("photo-id");var c=a(this).parents(".photo"),h=a("img",c[0]).attr("src"),e=a(".caption h5",c[0]).text(),c=a(".caption p",c[0]).text();g.html(l(b,h,e,c));k.modal("show");return!1}function n(){var b=a(".photo.selected",j).length;a(".select_all",d).prop("checked",a(".photo",j).length==b);0==b?a(".edit_selected, .remove_selected",d).addClass("disabled"):a(".edit_selected, .remove_selected",d).removeClass("disabled")}function w(){var b=a(this);b.is(":checked")?b.parent().addClass("selected"):b.parent().removeClass("selected");n()}function p(b){a(".deletePhoto",b).click(u);a(".editPhoto",b).click(v);a(".photo-select",b).change(w)}this.defaults={csrfToken:null,csrfTokenName:null,nameLabel:"Name",descriptionLabel:"Description",hasName:!0,hasDesc:!0,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:""};var b=a.extend({},this.defaults,m),d=a(t);b.wId=d.attr("id");var j=a(".sorter",d),s=a(".images",j),k=a(".editor-modal",d),g=a(".form",k);a(".photo",d).each(function(){p(this)});a(".images",j).sortable().disableSelection().bind("sortstop",function(){a.post(b.arrangeUrl,a("input",j).serialize()+"&ajax=true"+(b.csrfToken?"&"+b.csrfTokenName+"="+b.csrfToken:""),function(){},"json")});if("function"==typeof window.FormData)a(".afile",d).attr("multiple","true").on("change",function(f){f.preventDefault();var c=this.files.length,h=0;g.html("");for(f=0;f<c;f++){var e=new FormData;e.append(this.name,this.files[f]);b.csrfToken&&e.append(b.csrfTokenName,b.csrfToken);var d=new XMLHttpRequest;d.open("POST",b.uploadUrl,!0);d.onload=function(){h++;if(200==this.status){var e=JSON.parse(this.response),d=a(r(e.id,e.preview,e.name,e.description,e.sort));p(d);s.append(d);(b.hasName||b.hasDesc)&&g.append(a(l(e.id,e.preview,e.name,e.description)))}h===c&&(b.hasName||b.hasDesc)&&k.modal("show")};d.send(e)}});else a(".afile",d).on("change",function(d){d.preventDefault();g.html("");a.ajax(b.uploadUrl,{data:b.csrfToken?b.csrfTokenName+"="+b.csrfToken:"",files:a(this),iframe:!0,dataType:"json"}).done(function(c){var d=a(r(c.id,c.preview,c.name,c.description,c.sort));p(d);s.append(d);(b.hasName||b.hasDesc)&&g.append(a(l(c.id,c.preview,c.name,c.description)));(b.hasName||b.hasDesc)&&k.modal("show")})});a(".save-changes",k).click(function(f){f.preventDefault();a.post(b.updateUrl,a("input, textarea",g).serialize()+"&ajax=true"+(b.csrfToken?"&"+b.csrfTokenName+"="+b.csrfToken:""),function(c){for(var f=c.length,e=0;e<f;e++){var g=c[e],q=a("#"+b.wId+"-"+g.id);a("img",q).attr("src",g.src);b.hasName&&a(".caption h5",q).text(g.name);b.hasDesc&&a(".caption p",q).text(g.description)}k.modal("hide");a(".photo.selected",j).each(function(){a(".photo-select",this).prop("checked",!1)}).removeClass("selected");a(".select_all",d).prop("checked",!1);n()},"json")});a(".edit_selected",d).click(function(d){d.preventDefault();var c=0,h=g.html("");a(".photo.selected",j).each(function(){c++;var e=a(this),d=e.attr("id").substr((b.wId+"-").length),f=a("img",e[0]).attr("src"),g=a(".caption h5",e[0]).text(),e=a(".caption p",e[0]).text();h.append(l(d,f,g,e))});0<c&&k.modal("show");return!1});a(".remove_selected",d).click(function(d){d.preventDefault();a(".photo.selected",j).each(function(){var c=a(this).attr("id").substr((b.wId+"-").length);a.ajax({type:"POST",url:b.deleteUrl,data:"id="+c+(b.csrfToken?"&"+b.csrfTokenName+"="+b.csrfToken:""),success:function(d){"OK"==d?a("#"+b.wId+"-"+c).remove():alert(d)}})})});a(".select_all",d).change(function(){a(this).prop("checked")?a(".photo",j).each(function(){a(".photo-select",this).prop("checked",!0)}).addClass("selected"):a(".photo.selected",j).each(function(){a(".photo-select",this).prop("checked",!1)}).removeClass("selected");n()})}a.fn.galleryManager=function(a){this.length&&this.each(function(){m(this,a)})}})(jQuery);